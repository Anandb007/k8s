name: Tag, Push, and Deploy to ECR + K8s via ArgoCD

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      frontend-tag:
        description: 'Frontend tag to deploy'
        required: false
        default: 'frontend-v2'
      backend-tag:
        description: 'Backend tag to deploy'
        required: false
        default: 'backend-v2'

permissions:
  id-token: write       # OIDC for AWS
  contents: write       # Needed to update manifests

jobs:
  tag-push-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::486408064722:role/github-ecr-k8s-automation
          aws-region: us-east-1

      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region us-east-1 | \
          docker login --username AWS --password-stdin 486408064722.dkr.ecr.us-east-1.amazonaws.com

      - name: Pull, tag, and push frontend image
        run: |
          FRONTEND_TAG="${{ github.event.inputs.frontend-tag || 'frontend-v2' }}"
          docker pull 486408064722.dkr.ecr.us-east-1.amazonaws.com/frontend-backend-application:frontend-latest
          docker tag 486408064722.dkr.ecr.us-east-1.amazonaws.com/frontend-backend-application:frontend-latest 486408064722.dkr.ecr.us-east-1.amazonaws.com/front-back-end-services:$FRONTEND_TAG
          docker push 486408064722.dkr.ecr.us-east-1.amazonaws.com/front-back-end-services:$FRONTEND_TAG

      - name: Pull, tag, and push backend image
        run: |
          BACKEND_TAG="${{ github.event.inputs.backend-tag || 'backend-v2' }}"
          docker pull 486408064722.dkr.ecr.us-east-1.amazonaws.com/frontend-backend-application:backend-latest
          docker tag 486408064722.dkr.ecr.us-east-1.amazonaws.com/frontend-backend-application:backend-latest 486408064722.dkr.ecr.us-east-1.amazonaws.com/front-back-end-services:$BACKEND_TAG
          docker push 486408064722.dkr.ecr.us-east-1.amazonaws.com/front-back-end-services:$BACKEND_TAG

      - name: Update frontend deployment manifest
        run: |
          FRONTEND_TAG="${{ github.event.inputs.frontend-tag || 'frontend-v2' }}"
          sed -i "s|image: .*front-back-end-services:.*|image: 486408064722.dkr.ecr.us-east-1.amazonaws.com/front-back-end-services:$FRONTEND_TAG|" k8s-yaml-files/frontend-deployment.yaml
          git config user.name "anand"
          git config user.email "anand@github.com"
          git add k8s-yaml-files/frontend-deployment.yaml
          git commit -m "Update frontend image tag to $FRONTEND_TAG"
          git push

      - name: Update backend deployment manifest
        run: |
          BACKEND_TAG="${{ github.event.inputs.backend-tag || 'backend-v2' }}"
          sed -i "s|image: .*front-back-end-services:.*|image: 486408064722.dkr.ecr.us-east-1.amazonaws.com/front-back-end-services:$BACKEND_TAG|" k8s-yaml-files/backend-deployment.yaml
          git config user.name "anand"
          git config user.email "anand@github.com"
          git add k8s-yaml-files/backend-deployment.yaml
          git commit -m "Update backend image tag to $BACKEND_TAG"
          git push
